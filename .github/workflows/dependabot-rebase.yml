name: Dependabot Rebase Conflicts

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write       # <--- REQUIRED: Allows the bot to update the branch
  pull-requests: write

jobs:
  fix-conflicts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve Conflicts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Scanning open Dependabot PRs..."
          
          # Get Number, URL, and Status of all open Dependabot PRs
          gh pr list --app dependabot --state open --json number,url,mergeStateStatus | jq -c '.[]' | while read pr; do
            url=$(echo "$pr" | jq -r .url)
            num=$(echo "$pr" | jq -r .number)
            status=$(echo "$pr" | jq -r .mergeStateStatus)

            if [ "$status" == "DIRTY" ]; then
              echo "------------------------------------------------"
              echo "⚠️ Conflict detected in PR #$num: $url"
              echo "   Attempting to update branch via API..."
              
              # Call GitHub API to merge 'main' into the PR branch (resolves conflict)
              if gh api --method PUT "repos/${{ github.repository }}/pulls/$num/update-branch" > /dev/null 2>&1; then
                 echo "   ✅ Branch updated successfully! (Conflict resolved)"
              else
                 echo "   ❌ Automatic update failed (Conflict is too complex)."
                 # Leave a comment so you know you have to fix this one manually
                 gh pr comment "$url" --body "⚠️ Workflow tried to rebase but failed. Manual conflict resolution required."
              fi
            else
              echo "✅ PR #$num is clean ($status)"
            fi
          done